POST MORTEM PROCESSOR

import json

class PostMortemProcessor:
    def __init__(self, routing_core_path="/mnt/data/SIGNAL_ROUTING_CORE_RETROFITTED.json"):
        self.routing_core_path = routing_core_path

    def load_signals(self):
        with open(self.routing_core_path, "r") as f:
            return json.load(f)

    def save_signals(self, data):
        with open(self.routing_core_path, "w") as f:
            json.dump(data, f, indent=2)

    def process(self):
        data = self.load_signals()
        updated = False

        for node, node_data in data.items():
            signals = node_data.get("signals", {})
            for signal_name, packet in signals.items():
                lifecycle = packet.get("lifecycle", {})
                status = lifecycle.get("status")
                current_node = lifecycle.get("current_node")

                # Post Mortem processes signals marked COMPLETE or SUPPRESSED
                # and currently at POST_MORTEM node
                if current_node != "POST_MORTEM":
                    continue
                if status not in ["COMPLETE", "SUPPRESSED"]:
                    continue

                print(f"[POST_MORTEM] Processing signal: {signal_name}")

                for action in packet.get("actions", []):
                    self.execute_action(action, packet)

                # After post-mortem actions, mark signal as archived or finalized
                lifecycle["status"] = "ARCHIVED"
                print(f"[POST_MORTEM] Signal archived: {signal_name}")

                data[node]["signals"][signal_name]["lifecycle"] = lifecycle
                updated = True

        if updated:
            self.save_signals(data)

    def execute_action(self, action_name, packet):
        print(f"[POST_MORTEM] Executing action: {action_name}")
        # Add post-mortem specific logic here
        # e.g. tagging misfires, logging errors, syncing to AZORI_MEMORY

# === Example usage ===
if __name__ == "__main__":
    processor = PostMortemProcessor()
    processor.process()